#define AU float
#define BD return
#define CC vec2
#define CD vec3
#define LS length
#define LW normalize
uniform AU f;uniform CC r;const AU MAX_STEPS=32.,EPS=.1,END=100.,START=.0;const CD amb=.5*CD(1.,1.,1.);AU steps;CC A(CC a,CC b){AU c=a.y;if(a.x>b.x)c=b.y;BD CC(min(a.x,b.x),c);}CC B(CC a,CC b,AU c){AU d=clamp(.5+.5*(b.x-a.x)/c,.0,1.);AU e=a.y;if(a.x>b.x)e=b.y;BD CC(mix(b.x,a.x,d)-c*d*(1.-d),e);}AU C(CD a,AU b){BD LS(a)-b;}AU D(CD a,CC b){CC c=CC(LS(a.xy)-b.x,a.z);BD LS(c)-b.y;}AU E(in CD a,in CD b){AU c=LS(a/b);AU d=LS(a/(b*b));BD c*(c-1.)/d;}AU F(CD c,CD a,CD b,AU d){CD f=c-a,ba=b-a;AU e=clamp(dot(f,ba)/dot(ba,ba),.0,1.);BD LS(f-ba*e)-d;}AU G(CD a,AU b){AU c=C(a,b);AU d=(1.+sin(f/100.))/2.*.5*(sin(15.*a.x)*cos(15.*a.y)*sin(15.*a.z));BD c+d;}CC H(in CD a){CD b=CD(.0,sin(f/30.)*.5,.0);CC c=CC(G(a-b,1.),.0);c=A(c,CC(C(a-CD(-.3,.3,1.5)-b,.15),1.));c=A(c,CC(C(a-CD(.3,.3,1.5)-b,.15),1.));c=A(c,CC(C(a-CD(-.3,.3,1.7)-b,.5),2.));c=A(c,CC(C(a-CD(.3,.3,1.7)-b,.5),2.));c=A(c,CC(D(a-CD(.0,-.3,1.3)-b,CC(max(.5,(1.+sin(f/100.))*.2)/2.,.3)),3.));c=B(c,CC(E(a-CD(.9*(1.+sin(f/60.)/4.),-.9*(1.2-sin(f/30.)/6.),.5)-b,CD(.2,.3,.4)),0.),.7);c=B(c,CC(E(a-CD(-.9*(1.+sin(f/60.)/4.),-.9*(1.2-sin(f/30.)/6.),.5)-b,CD(.2,.3,.4)),0.),.7);c=A(c,CC(F(a-CD(.1,.5,1.)-b,CD(.1,.1,1.),CD(.35,.5,1.),.3),2.));c=A(c,CC(F(a-CD(-.1,.5,1.)-b,CD(-.1,.1,1.),CD(-.35,.5,1.),.3),2.));BD c;}CC I(CD c,CD a,AU d,AU b){AU e=e;for(AU f=0.;f<MAX_STEPS;f++){CC g=H(c+e*a);steps=f;if(g.x<EPS)BD CC(e,g.y);e+=g.x;if(e>=b)BD CC(b,.0);}BD CC(b,.0);}CD J(AU a,CC b){CC c=b*2.-1.;c.y=c.y/(16./9.);AU d=2./tan(radians(a/2.));BD LW(CD(c,-d));}CD K(CD a){BD LW(CD(H(CD(a.x+EPS,a.yz)).x-H(CD(a.x-EPS,a.yz)).x,H(CD(a.x,a.y+EPS,a.z)).x-H(CD(a.x,a.y-EPS,a.z)).x,H(CD(a.xy,a.z+EPS)).x-H(CD(a.xy,a.z-EPS)).x));}CD L(CD c,CD d,AU a,CD g,CD b,CD f,CD e){CD i=K(g);CD h=LW(f-g);CD k=LW(b-g);CD j=LW(reflect(-h,i));AU l=dot(h,i);AU m=dot(j,k);if(l<0.)BD CD(0.,0.,0.);if(m<0.)BD e*(c*l);BD e*(c*l+d*pow(m,a));}CD M(CD c,CD d,CD e,AU a,CD f,CD b){CD g=amb*c;CD j=CD(.0,1.*f/100.,30.*f/2e2.);CD h=CD(.4,.4,.4);CD i=L(d,e,a,f,b,j,h);g+=i;BD g;}void main(){CC g=gl_FragCoord.xy/r;CD c=CD(.0,.0,10.);CD b=J(6.,g);CC f=I(c,b,START,END);CD a=CD(.0);if(f.x>=END-EPS){AU d=min(max(0.,(steps-15.)*.8),1.);gl_FragColor=vec4(CD(d),1.);BD;}CD e=c+b*f.x;a=CD(g,.5+.5*sin(f/60.));if(f.y==1.)a=CD(.9);if(f.y==2.)a=CD(.0);if(f.y==3.)a=CD(.9,.0,.0);a=M(a,a,LW(CD(1.,1.,1.)),10.,e,c);gl_FragColor=vec4(a,1.);}
