uniform float f;uniform vec2 r;const float v=32.,g=.001,b=100.,n=0.;float i;vec2 e(vec2 v,vec2 b){float g=v.g;if(v.r>b.r)g=b.g;return vec2(min(v.r,b.r),g);}vec2 e(vec2 v,vec2 l,float g){float b=clamp(.5+.5*(l.r-v.r)/g,0.,1.),n=v.g;if(v.r>l.r)n=l.g;return vec2(mix(l.r,v.r,b)-g*b*(1.-b),n);}float l(vec3 v,float g){return length(v)-g;}float h(vec3 v,vec2 g){vec2 b=vec2(length(v.rg)-g.r,v.b);return length(b)-g.g;}float t(in vec3 v,in vec3 g){float l=length(v/g),n=length(v/(g*g));return l*(l-1.)/n;}float e(vec3 v,vec3 g,vec3 l,float b){vec3 n=v-g,i=l-g;float m=clamp(dot(n,i)/dot(i,i),0.,1.);return length(n-i*m)-b;}float m(vec3 v,float g){float b=l(v,g),n=(1.+sin(f/100.))/2.*.05*(sin(15.*v.r)*cos(15.*v.g)*sin(15.*v.b));return b+n;}vec2 e(in vec3 v){vec3 g=vec3(0.,sin(f/30.)*.5,0.);vec2 i=vec2(m(v-g,1.),0.);i=e(i,vec2(l(v-vec3(-.3,.3,1.5)-g,.15),1.));i=e(i,vec2(l(v-vec3(.3,.3,1.5)-g,.15),1.));i=e(i,vec2(l(v-vec3(-.3,.3,1.7)-g,.05),2.));i=e(i,vec2(l(v-vec3(.3,.3,1.7)-g,.05),2.));i=e(i,vec2(h(v-vec3(0.,-.3,1.3)-g,vec2(max(.05,(1.+sin(f/100.))*.2)/2.,.03)),3.));i=e(i,vec2(t(v-vec3(.9*(1.+sin(f/60.)/4.),-.9*(1.2-sin(f/30.)/6.),.5)-g,vec3(.2,.3,.4)),0.),.7);i=e(i,vec2(t(v-vec3(-.9*(1.+sin(f/60.)/4.),-.9*(1.2-sin(f/30.)/6.),.5)-g,vec3(.2,.3,.4)),0.),.7);i=e(i,vec2(e(v-vec3(.1,.5,1.)-g,vec3(.1,.1,1.),vec3(.35,.05,1.),.03),2.));i=e(i,vec2(e(v-vec3(-.1,.5,1.)-g,vec3(-.1,.1,1.),vec3(-.35,.05,1.),.03),2.));return i;}vec2 h(vec3 l,vec3 b,float n,float m){float s=n;for(float c=0.;c<v;c++){vec2 d=e(l+s*b);i=c;if(d.r<g)return vec2(s,d.g);s+=d.r;if(s>=m)return vec2(m,0.);}return vec2(m,0.);}vec3 x(float v,vec2 g){vec2 i=g*2.-1.;i.g=i.g/(16./9.);float b=2./tan(radians(v/2.));return normalize(vec3(i,-b));}vec3 h(vec3 v){return normalize(vec3(e(vec3(v.r+g,v.gb)).r-e(vec3(v.r-g,v.gb)).r,e(vec3(v.r,v.g+g,v.b)).r-e(vec3(v.r,v.g-g,v.b)).r,e(vec3(v.rg,v.b+g)).r-e(vec3(v.rg,v.b-g)).r));}vec3 e(vec3 v,vec3 g,float b,vec3 i,vec3 l,vec3 m,vec3 n){vec3 s=h(i),d=normalize(m-i),c=normalize(l-i),t=normalize(reflect(-d,s));float e=dot(d,s),x=dot(t,c);if(e<0.)return vec3(0.,0.,0.);if(x<0.)return n*(v*e);return n*(v*e+g*pow(x,b));}vec3 e(vec3 v,vec3 i,vec3 g,float n,vec3 b,vec3 l){const vec3 m=.5*vec3(1.,1.,1.);vec3 c=m*v,s=vec3(0.,f/100.,30.*f/2000.),d=vec3(.4,.4,.4),x=e(i,g,n,b,l,s,d);c+=x;return c;}void main(){vec2 v=gl_FragCoord.rg/r;vec3 l=vec3(0.,0.,10.),s=x(60.,v);vec2 m=h(l,s,n,b);vec3 d=vec3(0.);if(m.r>=b-g){float c=min(max(0.,(i-15.)*.08),1.);gl_FragColor=vec4(vec3(c),1.);return;}vec3 c=l+s*m.r;d=vec3(v,.5+.5*sin(f/60.));if(m.g==1.)d=vec3(.9);if(m.g==2.)d=vec3(0.);if(m.g==3.)d=vec3(.9,0.,0.);d=e(d,d,normalize(vec3(1.,1.,1.)),10.,c,l);gl_FragColor=vec4(d,1.);}
