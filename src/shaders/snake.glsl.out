#define AT float
#define BC return
#define CB vec2
#define CC vec3
#define LV normalize
uniform AT f;uniform CB r;const AT max_iterations=55.,stop_threshold=.001,grad_step=.1,clip_far=25.,p=2.,q=5.,PI=3.14159265359,DEG_TO_RAD=PI/18.;const CC dx=CC(grad_step,.0,.0),dy=CC(.0,grad_step,.0),dz=CC(.0,.0,grad_step);AT steps;AT A(AT a,AT b,AT c){AT d=exp2(-c*a)+exp2(-c*b);BC-log2(d)/c;}AT B(CC a,AT b){BC length(a)-b;}AT C(CC a,CC b){BC length(max(abs(a)-b,.0));}CC D(AT a){AT b=6.+cos(a*q);BC CC(b*cos(p*a),b*sin(p*a),-sin(q*a));}CC E(AT a){AT b=6.+cos(a*q);BC CC(-sin(q*a),b*cos(p*a),b*sin(p*a));}AT F(CC a,AT b){CC o=D(mod(b,2.*PI));AT c=B(a+o,2.);AT e=C(a+o,CC(1.4+.3*sin(b)));AT k=max(c,-e);for(AT m=0.;m<6.;m++){CC q=D(mod(b+m/4.,2.*PI));AT g=B(a+q,2.);AT m=C(a+q,CC(1.4+.3*sin(b)));k=A(k,max(g,-m),6.4);}a.x+=4.;a.y-=4.;CC p=E(mod(b-PI/2.,2.*PI));AT d=B(a+p,2.);AT f=C(a+p,CC(1.4+.3*sin(b)));AT l=max(d,-f);for(AT m=0.;m<6.;m++){CC r=E(mod(b+m/4.-PI/2.,2.*PI));AT h=B(a+r,2.);AT j=C(a+r,CC(1.4+.3*sin(b)));l=A(l,max(h,-j),6.4);}BC A(k,l,4.);}CC G(CC c,CC b,CC a){AT m=16.;CC g=CC(.0);CC f=LV(c-a);CC l=reflect(f,b);{CC j=CC(2.,2.,2.);CC h=CC(1.,.7,.7);CC p=LV(j-c);AT d=max(.0,dot(p,b));AT n=max(.0,dot(p,l));n=pow(n,m);g+=h*(d+n);}{CC j=CC(-2.,-2.,-2.);CC h=CC(.3,.7,1.);CC p=LV(j-c);AT d=max(.0,dot(p,b));AT n=max(.0,dot(p,l));n=pow(n,m);g+=h*(d+n);}BC g;}CC H(CC a,AT b){BC LV(CC(F(a+dx,b)-F(a-dx,b),F(a+dy,b)-F(a-dy,b),F(a+dz,b)-F(a-dz,b)));}AT I(CC c,CC a,AT d,AT b,AT e){AT f=d;for(AT h=0.;h<max_iterations;h++){steps=h*1.;AT g=F(c+a*f,e);if(g<stop_threshold){BC f;}f+=g;if(f>=b){BC b;}}BC b;}CC J(AT a,CB c,CB b){CB e=b-c*.5;AT d=tan((9.-a*.5)*DEG_TO_RAD);AT f=c.y*.5*d;BC LV(CC(e,-f));}mat3 K(CB a){CB b=cos(a);CB c=sin(a);BC mat3(b.y,.0,-c.y,c.y*c.x,b.x,b.y*c.x,c.y*b.x,-c.x,b.y*b.x);}vec4 L(CB a,CB b){vec4 f;AT h=f/60.;CB m=a/b.xy;AT i=min(1.,max(0.,1.*sin(m.y*100.)+(2.+sin(h*4.)*2.)*sin(m.x*100.)));CC d=J(45.,b.xy,a.xy);CC e=CC(.0,.0,15.);mat3 l=K(CB(h*.1));d=l*d;e=l*e;AT c=I(e,d,.0,clip_far,h);if(c>=clip_far){AT g=min(max(0.,(steps-15.)*.08),1.);f=vec4(CC(g)+CC(.8,.8,.3)*i,1.);BC f;}CC k=e+d*c;CC j=H(k,h);f=vec4(G(k,j,e),1.);BC f;}void main(){CB a=gl_FragCoord.xy/r;gl_FragColor=L(gl_FragCoord.xy,r);}
