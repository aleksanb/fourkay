uniform float f;uniform vec2 r;const float v=55.,d=.001,m=.1,g=250.,a=2.,s=5.,c=3.14159,e=c/180.;float n;float x(float s,float c,float g){float v=exp2(-g*s)+exp2(-g*c);return-log2(v)/g;}float x(vec3 v,float g){return length(v)-g;}float t(vec3 v,vec3 g){return length(max(abs(v)-g,0.));}vec3 t(float v){float m=6.+cos(v*s);return vec3(m*cos(a*v),m*sin(a*v),-sin(s*v));}vec3 x(float v){float m=6.+cos(v*s);return vec3(-sin(s*v),m*cos(a*v),m*sin(a*v));}float l(vec3 v,float g){vec3 m=t(mod(g,2.*c));float a=x(v+m,2.),s=t(v+m,vec3(1.4+.3*sin(g))),d=max(a,-s);for(float n=0.;n<6.;n++){vec3 l=t(mod(g+n/4.,2.*c));float e=x(v+l,2.),p=t(v+l,vec3(1.4+.3*sin(g)));d=x(d,max(e,-p),6.4);}v.r+=4.;v.g-=4.;vec3 l=x(mod(g-c/2.,2.*c));float n=x(v+l,2.),e=t(v+l,vec3(1.4+.3*sin(g))),i=max(n,-e);for(float p=0.;p<6.;p++){vec3 w=x(mod(g+p/4.-c/2.,2.*c));float o=x(v+w,2.),u=t(v+w,vec3(1.4+.3*sin(g)));i=x(i,max(o,-u),6.4);}return x(d,i,4.);}vec3 l(vec3 v,vec3 g,vec3 l){float m=16.;vec3 n=vec3(0.),d=normalize(v-l),s=reflect(d,g);{vec3 a=vec3(20.,20.,20.),e=vec3(1.,.7,.7),i=normalize(a-v);float p=max(0.,dot(i,g)),c=max(0.,dot(i,s));c=pow(c,m);n+=e*(p+c);}{vec3 a=vec3(-20.,-20.,-20.),e=vec3(.3,.7,1.),i=normalize(a-v);float p=max(0.,dot(i,g)),c=max(0.,dot(i,s));c=pow(c,m);n+=e*(p+c);}return n;}vec3 p(vec3 v,float g){const vec3 c=vec3(m,0.,0.),d=vec3(0.,m,0.),s=vec3(0.,0.,m);return normalize(vec3(l(v+c,g)-l(v-c,g),l(v+d,g)-l(v-d,g),l(v+s,g)-l(v-s,g)));}float l(vec3 g,vec3 m,float c,float s,float e){float i=c;for(float p=0.;p<v;p++){n=p;float a=l(g+m*i,e);if(a<d)return i;i+=a;if(i>=s)return s;}return s;}vec3 p(float g,vec2 v,vec2 m){vec2 i=m-v*.5;float s=tan((90.-g*.5)*e),c=v.g*.5*s;return normalize(vec3(i,-c));}mat3 l(vec2 v){vec2 m=cos(v),s=sin(v);return mat3(m.g,0.,-s.g,s.g*s.r,m.r,m.g*s.r,s.g*m.r,-s.r,m.g*m.r);}vec4 w(vec2 v,vec2 m){vec4 i;float s=f/60.;vec2 a=v/m.rg;float c=min(1.,max(0.,sin(a.g*100.)+(2.+sin(s*4.)*2.)*sin(a.r*100.)));vec3 d=p(45.,m.rg,v.rg),e=vec3(0.,0.,15.);mat3 t=l(vec2(s*.1));d=t*d;e=t*e;float w=l(e,d,0.,g,s);if(w>=g){float o=min(max(0.,(n-15.)*.08),1.);i=vec4(vec3(o)+vec3(.8,.8,.3)*c,1.);return i;}vec3 o=e+d*w,u=p(o,s);i=vec4(l(o,u,e),1.);return i;}void main(){vec2 v=gl_FragCoord.rg/r;gl_FragColor=w(gl_FragCoord.rg,r);}
